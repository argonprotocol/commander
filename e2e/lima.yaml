minimumLimaVersion: 1.1.0

base:
  - template://_images/ubuntu-lts
mounts:
  - location: '/tmp/lima'
    writable: true

cpus: 4
memory: '16GiB'
disk: '100GiB'

ssh:
  # A localhost port of the host. Forwarded to port 22 of the guest.
  # 游릭 Builtin default: 0 (automatically assigned to a free port)
  # NOTE: when the instance name is "default", the builtin default value is set to
  # 60022 for backward compatibility.
  localPort: 0
  # Load ~/.ssh/*.pub in addition to $LIMA_HOME/_config/user.pub .
  # This option is useful when you want to use other SSH-based
  # applications such as rsync with the Lima instance.
  # If you have an insecure key under ~/.ssh, do not use this option.
  # 游릭 Builtin default: true
  loadDotSSHPubKeys: true
  # Forward ssh agent into the instance.
  # The ssh agent socket can be mounted in a container at the path `/run/host-services/ssh-auth.sock`.
  # Set the environment variable `SSH_AUTH_SOCK` value to the path above.
  # The socket is accessible by the non-root user inside the Lima instance.
  # 游릭 Builtin default: false
  forwardAgent: true
  # Forward X11 into the instance
  # 游릭 Builtin default: false
  forwardX11: true
  # Trust forwarded X11 clients
  # 游릭 Builtin default: false
  forwardX11Trusted: true

hostResolver:
  hosts:
    host.docker.internal: host.lima.internal

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      # node install
      curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
      apt-get update

      # basic deps
      apt-get install -y curl git vim build-essential pkg-config

      # nodejs
      apt-get install -y nodejs

      # tauri deps
      apt-get install -y \
        libgtk-3-dev \
        libsoup-3.0-dev \
        libwebkit2gtk-4.1-dev \
        libjavascriptcoregtk-4.1-dev \
        libappindicator3-dev \
        librsvg2-dev \
        patchelf \
        libgtksourceview-3.0-dev \
        webkit2gtk-driver \
        xvfb \
        xsel # for clipboard support
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      command -v docker >/dev/null 2>&1 && exit 0
      export DEBIAN_FRONTEND=noninteractive
      curl -fsSL https://get.docker.com | sh
  - mode: data
    path: /etc/systemd/system/docker.socket.d/override.conf
    content: |
      [Socket]
      SocketUser={{.User}}
  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail
      curl https://sh.rustup.rs -sSf | sh -s -- -y
      echo 'source $HOME/.cargo/env' >> ~/.bashrc
      export PATH=$HOME/.cargo/bin:$PATH
      echo 'export PATH=$HOME/.cargo/bin:$PATH' >> ~/.bashrc
      source ~/.bashrc
      cargo install tauri-driver --locked --force --quiet
  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail
      sudo corepack enable --install-directory /usr/local/bin
      corepack prepare yarn@4.10.3 --activate
      echo 'export CI=true' >> ~/.bashrc
